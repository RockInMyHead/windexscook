import { OpenAIService } from './openai';
import { OpenAITTS } from './openai-tts';
import { OpenAISTT } from './openai-stt';

// Import types from voice-chat-system
import { ChatMessage } from '../voice-chat-system/src/services/openai';

class ChefAI {
  private systemPrompt: string;

  constructor() {
    this.systemPrompt = `–¢—ã ‚Äî Windexs, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –≤ –ª—É—á—à–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö –º–∏—Ä–∞.

–¢–í–û–Ø –†–û–õ–¨
- –¢—ã ‚Äî —à–µ—Ñ-–ø–æ–≤–∞—Ä –∏ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫
- –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ª—é–¥—è–º –≥–æ—Ç–æ–≤–∏—Ç—å –≤–∫—É—Å–Ω—É—é –∏ –∑–¥–æ—Ä–æ–≤—É—é –µ–¥—É
- –¢–≤–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–æ–º–∞—à–Ω—è—è –∫—É—Ö–Ω—è, —Ñ—å—é–∂–Ω-–∫—É—Ö–Ω—è, –∑–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ
- –¢—ã –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—à—å –∏ –º–æ—Ç–∏–≤–∏—Ä—É–µ—à—å –Ω–∞ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
- –¢—ã –≤—Å–µ–≥–¥–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ—à—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ –∫—É—Ö–Ω–µ –∏ –≥–∏–≥–∏–µ–Ω—É

–°–¢–ò–õ–¨ –ò –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í
- –û—Ç–≤–µ—á–∞–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –¢–∏–ø–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî 2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –±–µ–∑ –¥–ª–∏–Ω–Ω—ã—Ö –ª–µ–∫—Ü–∏–π.
- –í –ö–ê–ñ–î–û–ú –û–¢–í–ï–¢–ï –ó–ê–î–ê–í–ê–ô –¢–û–õ–¨–ö–û –û–î–ò–ù –í–û–ü–†–û–°! –ù–µ –∑–∞–¥–∞–≤–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ä–µ—Ü–µ–ø—Ç–µ, –¥–∞–≤–∞–π –∫—Ä–∞—Ç–∫—É—é –≤–µ—Ä—Å–∏—é —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —à–∞–≥–∞–º–∏, –∑–∞—Ç–µ–º —É—Ç–æ—á–Ω—è–π –¥–µ—Ç–∞–ª–∏.
- –ì–æ–≤–æ—Ä–∏—à—å –ø–æ-–¥–µ–ª–æ–≤–æ–º—É, –Ω–æ —Ç–µ–ø–ª–æ –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ.
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π –∂–∞—Ä–≥–æ–Ω —É–º–µ—Ä–µ–Ω–Ω–æ, –æ–±—ä—è—Å–Ω—è—è –µ–≥–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
- –í—Å–µ–≥–¥–∞ –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞–µ—à—å –∏ –æ—Ç–º–µ—á–∞–µ—à—å —É—Å–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ú–æ–∂–µ—à—å –±—ã—Ç—å —Å—Ç—Ä–æ–≥–∏–º –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö —Ç–µ—Ö–Ω–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ –ø—É–≥–∞–µ—à—å.

–ö–£–õ–ò–ù–ê–†–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
- –°–≤–µ–∂–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã ‚Äî –æ—Å–Ω–æ–≤–∞ –≤–∫—É—Å–Ω–æ–≥–æ –±–ª—é–¥–∞
- –¢–µ—Ö–Ω–∏–∫–∞ –≤–∞–∂–Ω–µ–µ, —á–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ—Ü–µ–ø—Ç–∞
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è, –Ω–æ —Å –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –æ—Å–Ω–æ–≤
- –ó–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ: –±–∞–ª–∞–Ω—Å –±–µ–ª–∫–æ–≤, –∂–∏—Ä–æ–≤, —É–≥–ª–µ–≤–æ–¥–æ–≤

–§–û–†–ú–ê–¢ –†–ï–¶–ï–ü–¢–û–í
–ï—Å–ª–∏ –¥–∞–µ—à—å —Ä–µ—Ü–µ–ø—Ç:
1. –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
2. –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
3. –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (5‚Äì8 –∫–ª—é—á–µ–≤—ã—Ö)
4. 3‚Äì5 –æ—Å–Ω–æ–≤–Ω—ã—Ö —à–∞–≥–æ–≤ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
5. –û–¥–∏–Ω —Å–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞

–ü–†–ò–ù–¶–ò–ü–´ –†–ê–ó–ì–û–í–û–†–ê
- –í –ö–ê–ñ–î–û–ú –û–¢–í–ï–¢–ï –ó–ê–î–ê–í–ê–ô –¢–û–õ–¨–ö–û –û–î–ò–ù –í–û–ü–†–û–°!
- –í–Ω–∞—á–∞–ª–µ —É—Ç–æ—á–Ω—è–µ—à—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: –≤–∫—É—Å—ã, –∞–ª–ª–µ—Ä–≥–∏–∏, –∫—É—Ö–æ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π —Ç–µ—Ä–º–∏–Ω, –æ–±—ä—è—Å–Ω—è–µ—à—å –µ–≥–æ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π.
- –§–æ–∫—É—Å–∏—Ä—É–µ—à—å—Å—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–∞—Ö, –∞ –Ω–µ —Ç–µ–æ—Ä–∏–∏.
- –í–º–µ—Å—Ç–æ –¥–ª–∏–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤ –¥–∞–µ—à—å –æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥ –∏–ª–∏ —Å–æ–≤–µ—Ç.

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨
- –ù–µ –¥–∞–µ—à—å —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—é —Å—ã—Ä—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–º—è—Å–æ, —Ä—ã–±–∞) –±–µ–∑ —Ç–µ—Ä–º–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—à—å –æ–± –∞–ª–ª–µ—Ä–≥–µ–Ω–∞—Ö –∏ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–Ω–æ–º –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–∏
- –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—à—å —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–ª–∏ –º–µ—Ç–æ–¥—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
- –ü—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏ –Ω–∞ –ø–∏—â–µ–≤–æ–µ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî —Å–æ–≤–µ—Ç—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ú–û–ú–ï–ù–¢–´
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ –∏–º–µ–Ω–∏, –æ—Ç–≤–µ—á–∞–µ—à—å –∫–∞–∫ "Windexs".
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç, –∫—Ç–æ —Ç—ã, —á–µ—Å—Ç–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—à—å, —á—Ç–æ —Ç—ã –ò–ò-—à–µ—Ñ-–ø–æ–≤–∞—Ä.
- –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—à—å —Ç–µ–∫—Å—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.
- –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω.

–¢–í–û–Ø –¶–ï–õ–¨
–ü–æ–º–æ–≥–∞—Ç—å –ª—é–¥—è–º –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–¥–æ—Å—Ç—å –∫—É–ª–∏–Ω–∞—Ä–∏–∏, —É—á–∏—Ç—å –≥–æ—Ç–æ–≤–∏—Ç—å –≤–∫—É—Å–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –¥–µ–ª–∏—Ç—å—Å—è –∑–Ω–∞–Ω–∏—è–º–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –Ω–∞ –Ω–æ–≤—ã–µ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è.`;
  }

  async getVoiceResponse(messages: ChatMessage[], memoryContext = '', fastMode = false): Promise<string> {
    try {
      // Convert messages to the format expected by OpenAIService
      const messageHistory = messages.slice(-10).map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      // Use OpenAIService.chatWithChef with voice mode enabled for faster responses
      const result = await OpenAIService.chatWithChef(
        messages[messages.length - 1]?.content || '', // Last user message
        undefined, // healthProfile
        messageHistory.slice(0, -1), // Previous messages without the last one
        true // voiceMode = true –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
      );

      return result.content;
    } catch (error) {
      console.error('Error getting chef AI response:', error);
      return '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ú–æ–∂–µ—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ç–æ–º, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å?';
    }
  }

  async synthesizeSpeech(text: string): Promise<ArrayBuffer> {
    try {
      const result = await OpenAITTS.generateAudio(text, "alloy");
      return await result.blob.arrayBuffer();
    } catch (error) {
      console.error('Error synthesizing speech for chef:', error);
      throw error;
    }
  }

  async transcribeAudio(audioBlob: Blob): Promise<string> {
    try {
      console.log('üåê [Chef AI] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é...', {
        blobSize: audioBlob.size,
        blobType: audioBlob.type
      });

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ MIME —Ç–∏–ø—É
      let extension = 'webm';
      if (audioBlob.type.includes('mp4') || audioBlob.type.includes('m4a')) {
        extension = 'm4a';
      } else if (audioBlob.type.includes('wav')) {
        extension = 'wav';
      } else if (audioBlob.type.includes('mp3') || audioBlob.type.includes('mpeg')) {
        extension = 'mp3';
      } else if (audioBlob.type.includes('ogg')) {
        extension = 'ogg';
      } else if (audioBlob.type.includes('flac')) {
        extension = 'flac';
      }

      const formData = new FormData();
      formData.append('file', audioBlob, `audio.${extension}`);
      formData.append('model', 'whisper-1');
      formData.append('language', 'ru');
      formData.append('response_format', 'text');

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é
      const response = await fetch('/api/audio/transcriptions', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå [Chef AI] –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏:', errorText);
        throw new Error(`–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏: ${response.status}`);
      }

      const transcription = await response.text();
      console.log('‚úÖ [Chef AI] –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', transcription);
      return transcription.trim();

    } catch (error) {
      console.error('Error transcribing audio for chef:', error);
      throw error;
    }
  }
}

export const chefAI = new ChefAI();

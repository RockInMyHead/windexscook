# Исправления для деплоя Pastel Chef AI

## Проблемы, которые были исправлены:

### 1. Проксирование API запросов
**Проблема**: API запросы шли напрямую к внешним сервисам, минуя сервер.

**Решение**:
- ✅ Добавлено проксирование для ElevenLabs API через `/api/elevenlabs`
- ✅ Добавлено проксирование для OpenAI API через `/api/openai`
- ✅ Обновлены клиентские сервисы для использования прокси
- ✅ API ключи теперь добавляются на сервере, а не в клиенте

### 2. Система логирования
**Проблема**: Отсутствовали логи для диагностики ошибок.

**Решение**:
- ✅ Добавлена централизованная система логирования
- ✅ Логи сохраняются в файлы в директории `logs/`
- ✅ Логируются все HTTP запросы с деталями
- ✅ Логируются ошибки API с полной информацией
- ✅ Логи монтируются в Docker для доступа с хоста

## Что изменилось:

### В `server.js`:
- Добавлена функция `logToFile()` для записи логов
- Добавлен middleware `requestLogger` для логирования запросов
- Добавлен прокси для OpenAI API (`/api/openai`)
- Улучшено логирование ошибок в прокси-роутах
- Создается директория `logs/` автоматически

### В `src/services/elevenlabs.ts`:
- Изменен `BASE_URL` с `https://api.elevenlabs.io/v1` на `/api/elevenlabs`
- Убраны прямые API ключи из клиентского кода
- Все запросы теперь идут через прокси

### В `src/services/openai.ts`:
- Изменен URL с `https://api.openai.com/v1/chat/completions` на `/api/openai/v1/chat/completions`
- Убрана проверка API ключа в клиенте
- Все запросы теперь идут через прокси

### В `Dockerfile`:
- Добавлено создание директории `logs/`
- Настроены права доступа для записи логов

### В `docker-compose.yml`:
- Добавлен volume для монтирования директории логов
- Логи теперь доступны на хосте в `./logs/`

## Как проверить исправления:

### 1. Проверка проксирования:
```bash
# Запустить сервер
npm run server

# Проверить логи в консоли - должны быть сообщения о проксировании
# Проверить логи в файле logs/YYYY-MM-DD.log
```

### 2. Проверка API запросов:
- Открыть DevTools в браузере
- Перейти на страницу с AI функциями
- В Network tab должны быть запросы к `/api/elevenlabs/*` и `/api/openai/*`
- НЕ должно быть прямых запросов к `api.elevenlabs.io` или `api.openai.com`

### 3. Проверка логов:
```bash
# Посмотреть логи в реальном времени
tail -f logs/$(date +%Y-%m-%d).log

# Или в Docker
docker-compose logs -f pastel-chef-ai
```

## Переменные окружения:

Убедитесь, что установлены:
```bash
ELEVENLABS_API_KEY=your_elevenlabs_key
VITE_OPENAI_API_KEY=your_openai_key
```

## Деплой:

```bash
# Сборка и запуск
docker-compose up --build

# Проверка здоровья
curl http://localhost:3001/health

# Проверка логов
docker-compose logs pastel-chef-ai
```

## Мониторинг:

1. **Логи приложения**: `./logs/YYYY-MM-DD.log`
2. **Docker логи**: `docker-compose logs pastel-chef-ai`
3. **Health check**: `http://localhost:3001/health`

Теперь девопс сможет:
- ✅ Видеть все API запросы в логах
- ✅ Диагностировать ошибки проксирования
- ✅ Мониторить производительность API вызовов
- ✅ Получать детальную информацию об ошибках
